{% extends 'base.html' %}

{% block title %}NTWKInfo - BÄ…dÅº na czasie{% endblock %}

{% block content %}

<html lang="pl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kursy walut i zÅ‚ota</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- custom bootstrap-themed styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/ekonomia.css') }}" />
</head>
<body>
<!-- DODAJ ODSTÄ˜P POD NAVBAREM, Å»EBY NIE ZACHODZIÅ NA TREÅšÄ† -->
<div class="container py-4">
    <h1 class="mb-4 header-title">ðŸ’± Kursy walut i cena zÅ‚ota</h1>

    <!-- Currency row: use Bootstrap row/cols but keep currency-box classes for CSS -->
<div class="currency-scroll">
    {% for waluta, kurs in kurs_walut.items() %}
    <div class="currency-item">
        <div class="card currency-box">
            <div class="card-body text-center">
                <div class="currency-title">{{ waluta }} to PLN</div>
                <div class="currency-value">{{ "%.2f" | format(kurs) }} zÅ‚</div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>


    <h2 class="mt-4 calc-heading">Kalkulator walut</h2>

    <!-- Calculator: Bootstrap layout, keeps original client-side logic -->
    <div class="d-flex flex-column flex-md-row align-items-center justify-content-center gap-4 calc-container mb-4">
        <div class="calc-box p-3">
            <form class="d-flex align-items-center flex-wrap">
                <div class="d-flex flex-column me-3 input-column">
                    <div class="input-group mb-2">
                        <input id="amount" type="text" class="form-control" placeholder="Kwota" aria-label="Kwota"
                               inputmode="decimal" pattern="[0-9]+([.,][0-9]+)?">
                    </div>
                    <div class="input-group">
                        <input id="result" type="text" class="form-control" placeholder="Przeliczona" aria-label="Wynik" readonly>
                    </div>
                </div>

                <div class="d-flex flex-column align-items-center" style="min-width:140px;">
                    <select id="currency-from" class="form-select mb-2" style="width:100%;">
                        <!-- PLN jako opcja oraz lista z serwera -->
                        <option value="PLN">PLN</option>
                        {% for code in currency_codes %}
                        <option value="{{ code }}">{{ code }}</option>
                        {% endfor %}
                    </select>
                    <!-- clickable swap button -->
                    <span id="swap-btn" role="button" title="ZamieÅ„" style="cursor:pointer; user-select:none;">ðŸ”ƒ</span>
                    <select id="currency-to" class="form-select mt-2" style="width:100%;">
                        <option value="EUR">EUR</option>
                        {% for code in currency_codes %}
                        <option value="{{ code }}">{{ code }}</option>
                        {% endfor %}
                    </select>
                </div>

            </form>
        </div>

        <div class="text-center">
            <img src="data:image/png;base64,{{ wykres_waluty }}" alt="Wykres walut" class="currency-chart img-fluid">
        </div>
    </div>

    <h2 class="calc-heading">Cena zÅ‚ota dziÅ›</h2>
    <p class="gold-price">{{ cena_zlota }} [t oz]</p>

    <h2 class="mt-4 calc-heading">Kurs zÅ‚ota [t oz] - widok w skali roku</h2>
    <div class="d-flex justify-content-center mb-4">
        <img src="data:image/png;base64,{{ wykres_zlota }}" alt="Wykres zÅ‚ota" class="gold-chart img-fluid" style="width:100%; max-width:1200px;">
    </div>
</div>

<!-- Client-side conversion script (przeniesione z oryginalnego index.html) -->
<script>
(function() {
    const RATES = {{ currency_rates | tojson | safe }};

    const amountEl = document.getElementById('amount');
    const fromEl = document.getElementById('currency-from');
    const toEl = document.getElementById('currency-to');
    const resultEl = document.getElementById('result');

    const PL_FORMATTER = new Intl.NumberFormat('pl-PL', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 4
    });

    function compute() {
        const raw = amountEl.value.trim();
        if (raw === '') { resultEl.value = ''; return; }

        const hasTrailingSep = /[.,]$/.test(raw);
        const normalized = raw.replace(',', '.');
        const a = parseFloat(normalized);

        if (isNaN(a)) { resultEl.value = ''; return; }

        const from = fromEl.value || 'PLN';
        const to = toEl.value || 'PLN';

        const rateFrom = RATES[from] !== undefined ? RATES[from] : 1;
        const rateTo = RATES[to] !== undefined ? RATES[to] : 1;

        const inPln = a * rateFrom;
        const res = inPln / rateTo;

        let formatted = PL_FORMATTER.format(res);
        if (hasTrailingSep) {
            if (!formatted.includes(',')) {
                formatted = formatted + ',';
            } else if (formatted.endsWith(',')) {
                // already ends with comma
            } else {
                formatted = formatted + ',';
            }
        }

        resultEl.value = formatted;
    }

    function enforceTwoDecimals() {
        let raw = amountEl.value;
        if (!raw) return;

        // remember if user typed a trailing separator (dot or comma)
        const hadTrailingSep = /[.,]$/.test(raw);

        // remove any characters except digits and separators
        let s = raw.replace(/[^0-9.,]/g, '');

        // normalize commas to dot for processing
        let normalized = s.replace(/,/g, '.');

        // keep only the first dot, remove further dots
        const firstDot = normalized.indexOf('.');
        if (firstDot !== -1) {
            normalized = normalized.slice(0, firstDot + 1) + normalized.slice(firstDot + 1).replace(/\./g, '');
        }

        // limit to two decimal places if dot present
        if (normalized.indexOf('.') !== -1) {
            const [intPart, decPart = ''] = normalized.split('.');
            const dec = decPart.slice(0, 2);
            // if user had trailing separator, keep a trailing dot to indicate they typed it
            normalized = intPart + (dec.length > 0 ? '.' + dec : (hadTrailingSep ? '.' : ''));
        }

        // Update the input value (uses dot as separator for consistency in parsing)
        amountEl.value = normalized;
    }

    amountEl.addEventListener('input', function () { enforceTwoDecimals(); compute(); });
    fromEl.addEventListener('change', compute);
    toEl.addEventListener('change', compute);

    // Optional: button to trigger compute for users who click it
    document.querySelectorAll('.calc-box .btn').forEach(btn => btn.addEventListener('click', compute));

    // --- NEW: swap handler for the emoji ---
    const swapBtn = document.getElementById('swap-btn');
    if (swapBtn) {
        swapBtn.addEventListener('click', function() {
            const valFrom = fromEl.value;
            const valTo = toEl.value;

            // helper: ensure select contains option with given value
            function ensureOption(sel, val) {
                if (val === undefined || val === null || val === '') return;
                for (let i = 0; i < sel.options.length; i++) {
                    if (sel.options[i].value === val) return;
                }
                // add new option (label == value)
                const opt = new Option(val, val);
                sel.add(opt);
            }

            // ensure both selects can accept swapped values
            ensureOption(fromEl, valTo);
            ensureOption(toEl, valFrom);

            // perform swap
            fromEl.value = valTo;
            toEl.value = valFrom;

            // recompute result and focus amount
            compute();
            amountEl.focus();
        });
    }

    compute();
})();
</script>

<!-- Bootstrap JS bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

{% endblock %}